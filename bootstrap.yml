---

- hosts: test
  become: yes
  vars_prompt:
    - name: password
      prompt: Input new password for user
  tasks:
    - name: Change password
      user:
        name: "{{ usr }}"
        update_password: always
        password: "{{password | password_hash('sha512')}}"
    - name: Update and upgrade packages
      apt:
        update_cache: yes
        upgrade: yes
    - name: Install docker and required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - docker
          - docker-compose
          - git
          - gnupg-agent
          - gocryptfs
          - apache2-utils
          - software-properties-common
    - name: Add 'docker' group
      group:
        name: docker
    - name: Add user to 'docker' group
      user:
        append: yes
        groups: docker
        name: "{{ usr }}"
    - name: Install 'megacmd'
      apt:
        deb: https://mega.nz/linux/MEGAsync/Raspbian_10.0/armhf/megacmd-Raspbian_10.0_armhf.deb
    - name: Clone 'homeserver' repo
      become: no
      git:
        repo: https://github.com/Kwbmm/Homeserver.git
        dest: homeserver
    - name: Set firefly crontab
      ansible.builtin.cron:
        name: Launch firefly daily tx
        minute: 0
        hour: 3
        job: ~/homeserver/firefly-recurring-trans.sh
        user: "{{ usr }}"